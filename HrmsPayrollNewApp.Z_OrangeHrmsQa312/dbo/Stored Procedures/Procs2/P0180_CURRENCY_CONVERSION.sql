

---18/1/2021 (EDIT BY MEHUL ) (SP WITH NOLOCK)---
CREATE PROCEDURE [dbo].[P0180_CURRENCY_CONVERSION]
 @CURR_CONV_ID NUMERIC output
,@CMP_ID NUMERIC
,@CURR_ID NUMERIC
,@FOR_DATE DATETIME
,@CURR_RATE NUMERIC(22,2)
,@TRANSTYPE CHAR(1)
AS
SET NOCOUNT ON 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET ARITHABORT ON
 
IF @TRANSTYPE='I'
			BEGIN
				IF EXISTS (SELECT CURR_CONV_ID  FROM T0180_CURRENCY_CONVERSION WITH (NOLOCK) WHERE CMP_ID=@CMP_ID AND FOR_DATE=@FOR_DATE AND CURR_ID=@CURR_ID)
					BEGIN
						SET @CURR_CONV_ID=0
						RETURN
					END
				SELECT  @CURR_CONV_ID = Isnull(max(CURR_CONV_ID),0) + 1 	From T0180_CURRENCY_CONVERSION WITH (NOLOCK)
				
				INSERT INTO T0180_CURRENCY_CONVERSION(CURR_CONV_ID,CMP_ID,CURR_ID,FOR_DATE,CURR_RATE)
				VALUES(@CURR_CONV_ID,@CMP_ID,@CURR_ID,@FOR_DATE,@CURR_RATE)
			END
ELSE IF @TRANSTYPE='U'			
			BEGIN
				IF EXISTS (SELECT CURR_CONV_ID  FROM T0180_CURRENCY_CONVERSION WITH (NOLOCK) WHERE CMP_ID=@CMP_ID AND FOR_DATE=@FOR_DATE AND CURR_ID = @CURR_ID AND CURR_CONV_ID <> @CURR_CONV_ID)
					BEGIN
						SET @CURR_CONV_ID=0
						RETURN
					END
				UPDATE T0180_CURRENCY_CONVERSION 
				SET FOR_DATE=@FOR_DATE 
				    ,CURR_ID = @CURR_ID 
				    ,CURR_RATE=@CURR_RATE 
				WHERE CURR_CONV_ID = @CURR_CONV_ID
			END
ELSE IF @TRANSTYPE='D'
		BEGIN
			---if Exists(select Curr_ID from T0140_Travel_Settlement_Expense WITH (NOLOCK) where Cmp_ID=@CMP_ID and Curr_ID=@Curr_ID)
				if Exists(select Distinct Curr_ID from T0140_Travel_Settlement_Expense WITH (NOLOCK) where Cmp_ID=@CMP_ID and Curr_ID=@Curr_ID and (select distinct Curr_ID from T0130_Travel_Approval_Other_Detail WITH (NOLOCK) where Cmp_ID=@CMP_ID and Curr_ID=@Curr_ID)>0)  ---Add By Manisha on 20112024 for Bug #31925

				begin
					RAISERROR('@@ Reference Exists @@',16,2)
					RETURN	
				end	
			----if Exists(select Curr_ID from T0130_Travel_Approval_Other_Detail WITH (NOLOCK) where Cmp_ID=@CMP_ID and Curr_ID=@Curr_ID)
				if Exists(select Distinct Curr_ID from T0130_Travel_Approval_Other_Detail WITH (NOLOCK) where Cmp_ID=@CMP_ID and Curr_ID=@Curr_ID and (select Distinct Curr_ID from T0130_Travel_Approval_Other_Detail WITH (NOLOCK) where Cmp_ID=@CMP_ID and Curr_ID=@Curr_ID)>0)   ----Add By Manisha on 20112024 for Bug #31925
				begin
					RAISERROR('@@ Reference Exists @@',16,2)
					RETURN	
				end							
		
				DELETE FROM  T0180_CURRENCY_CONVERSION WHERE CURR_CONV_ID = @CURR_CONV_ID
			END
ELSE IF @TRANSTYPE='F' -- ADDED BY RAJPUT ON 14032018
		BEGIN
		
			SELECT TOP 1 * FROM   T0180_CURRENCY_CONVERSION INC WITH (NOLOCK)
					INNER JOIN (SELECT	FOR_DATE AS FOR_DATE
					FROM	T0180_CURRENCY_CONVERSION I1 WITH (NOLOCK)
					WHERE FOR_DATE <= GETDATE()) QRY1 ON INC.FOR_DATE=QRY1.FOR_DATE
					WHERE INC.CMP_ID=@CMP_ID and INC.CURR_ID=@CURR_ID ORDER BY INC.FOR_DATE DESC
			
		END
RETURN


